<script>
  // ✅ Google Apps Script Web App URL
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwE1pMUQ61CwBDXCA_q98YUm_34Uy9oNJQ8I_XBO4VAtUNAuB2EJOZ62h3UPVRs_hfHKw/exec";

  // ✅ Tracking function
  function trackUserDetails(shopid, shopname, marketname, role) {
    fetch(SHEET_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        shopid,
        shopname,
        marketname,
        role,
        timestamp: new Date().toISOString()
      })
    });
    console.log("Logging:", shopid, shopname, marketname, role);
  }

  // Shop data
  const shopData = [
    { shopid: 101, shopname: "FABINDIA", marketname: "KHAN MARKET" },
    { shopid: 102, shopname: "BLUE TOKAI", marketname: "RAJOURI GARDEN" },
    { shopid: 103, shopname: "SHOPPE", marketname: "HAUZ KHAS VILLAGE" },
    { shopid: 104, shopname: "NAPPA DORI", marketname: "VASANT VIHAR" },
    { shopid: 105, shopname: "HALDIRAMS", marketname: "NEW FRIENDS COLONY" }
  ];

  const params = new URLSearchParams(window.location.search);
  const shopIdFromUrl = parseInt(params.get("shopid"));

  const shopDetails = document.getElementById("shop-details");
  const confirmationMsg = document.getElementById("confirmation-msg");
  const shopIdElement = document.getElementById("shop-id");

  const detailsSection = document.getElementById("details-section");
  const correctionSection = document.getElementById("correction-section");
  const confirmationSection = document.getElementById("confirmation-section");
  const finalSection = document.getElementById("final-section");

  let shop = shopData.find(shop => shop.shopid === shopIdFromUrl);
  if (shop) {
    shopDetails.innerText = `Shop: ${shop.shopname} | Market: ${shop.marketname}`;
  } else {
    shopDetails.innerText = "⚠️ Shop not found!";
  }

  // Yes button
  document.getElementById("confirm-btn").onclick = () => {
    confirmationMsg.innerText = `Confirmed: ${shop.shopname}, ${shop.marketname}`;
    shopIdElement.innerText = shop.shopid;
    detailsSection.classList.add("hidden");
    confirmationSection.classList.remove("hidden");

    // Show popup modal
    document.getElementById("popup-password").innerText = shop.shopid;
    document.getElementById("passwordModal").style.display = "block";

    // ✅ Log confirmation
    trackUserDetails(shop.shopid, shop.shopname, shop.marketname, "Confirmed");
  };

  // Close modal
  function closeModal() {
    document.getElementById("passwordModal").style.display = "none";
  }

  // Copy function
  function copyPassword() {
    const password = document.getElementById("popup-password").innerText;
    navigator.clipboard.writeText(password).then(() => {
      document.getElementById("copy-msg").style.display = "block";
      setTimeout(() => { closeModal(); }, 1200);
    });
  }

  // No button
  document.getElementById("deny-btn").onclick = () => {
    detailsSection.classList.add("hidden");
    correctionSection.classList.remove("hidden");
  };

  // Submit corrected details
  document.getElementById("submit-correction").onclick = () => {
    const newShopName = document.getElementById("correct-shopname").value.trim();
    const newMarketName = document.getElementById("correct-marketname").value.trim();
    if (!newShopName || !newMarketName) {
      alert("Please fill both fields!");
      return;
    }

    confirmationMsg.innerText = `Corrected: ${newShopName}, ${newMarketName}`;
    shopIdElement.innerText = shopIdFromUrl;

    correctionSection.classList.add("hidden");
    confirmationSection.classList.remove("hidden");

    document.getElementById("popup-password").innerText = shopIdFromUrl;
    document.getElementById("passwordModal").style.display = "block";

    // ✅ Log correction
    trackUserDetails(shopIdFromUrl, newShopName, newMarketName, "Corrected");
  };

  // Proceed button
  document.getElementById("go-to-links-btn").onclick = () => {
    confirmationSection.classList.add("hidden");
    finalSection.classList.remove("hidden");
    window.scrollTo(0, document.body.scrollHeight);
  };

  // Training links
  const classroom1Link = "https://edpuzzle.com/assignments/68b1a7f9ddde8cb5f8362210/watch";
  const classroom2Link = "https://edpuzzle.com/assignments/68b1a7f9ddde8cb5f8362210/watch";

  document.getElementById("btn-employer").onclick = () => {
    // ✅ Log Employer training
    trackUserDetails(shop.shopid, shop.shopname, shop.marketname, "Employer");
    window.location.href = classroom1Link;
  };

  document.getElementById("btn-employee").onclick = () => {
    // ✅ Log Employee training
    trackUserDetails(shop.shopid, shop.shopname, shop.marketname, "Employee");
    window.location.href = classroom2Link;
  };
</script>
